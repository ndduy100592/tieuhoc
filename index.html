<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHATBOT HỌC TẬP NÂNG CAO CHẤT LƯỢNG TỰ HỌC</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&display=swap');

        body {
            font-family: 'Quicksand', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            color: #333;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://bvhttdl.mediacdn.vn/291773308735864832/2024/12/2/0211ditichtantrao1-1733104546432-1733104546771617645710.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            filter: blur(0px);
            z-index: -1;
        }

        #home-menu {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            margin: 20px;
            flex-grow: 1;
        }

        #home-menu h1 {
            color: #26a69a;
            margin-bottom: 40px;
            font-size: 2.8em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 25px 50px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border: 2px solid rgba(76, 175, 80, 0.4);
        }

        .subject-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            width: 85%;
            max-width: 1100px;
            margin-bottom: 35px;
        }

        .subject-button {
            background-color: rgba(76, 175, 80, 0.9);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 25px 20px;
            font-size: 1.4em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 18px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            backdrop-filter: blur(8px);
            border: 2px solid rgba(255, 255, 255, 0.4);
            min-height: 140px;
        }

        .subject-button i {
            font-size: 3.2em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subject-button:hover {
            background-color: rgba(56, 142, 60, 0.95);
            transform: translateY(-7px) scale(1.03);
            box-shadow: 0 12px 25px rgba(0,0,0,0.3);
            border-color: rgba(255, 255, 255, 0.6);
        }

        #contact-info {
            margin-top: 5px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            width: 65%;
            max-width: 700px;
            border: 2px solid rgba(38, 166, 154, 0.4);
            text-align: center;
        }

        #contact-info h3 {
            color: #26a69a;
            margin-top: 0;
            margin-bottom: 12px;
            font-size: 1.3em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .contact-item {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            font-size: 1em;
            color: #333;
            flex-wrap: wrap;
        }

        .contact-item i {
            color: #4CAF50;
            margin-right: 8px;
            font-size: 1.1em;
            width: 20px;
            text-align: center;
        }

        .contact-name {
            font-weight: 700;
            color: #2c7873;
            margin-right: 8px;
            font-size: 1em;
        }

        .contact-divider {
            margin: 0 10px;
            color: #ccc;
            font-size: 1em;
        }

        footer {
            background-color: rgba(38, 166, 154, 0.95);
            color: white;
            padding: 15px 0;
            text-align: center;
            width: 100%;
            margin-top: auto;
            border-top: 3px solid #2c7873;
            backdrop-filter: blur(10px);
        }

        .footer-line {
            height: 3px;
            background: linear-gradient(90deg, transparent, #ffffff, transparent);
            width: 100%;
            margin-bottom: 12px;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .footer-content p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .footer-content i {
            margin-right: 8px;
            color: #c5e1a5;
        }

        #chatbot-container {
            display: none;
            flex-direction: row;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
            margin: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            flex-grow: 1;
            min-height: 0;
        }

        #sidebar {
            width: 200px;
            background-color: rgba(240, 244, 195, 0.9);
            padding: 15px;
            border-right: 1px solid #dce775;
            display: flex;
            flex-direction: column;
            box-shadow: inset -2px 0 5px rgba(0,0,0,0.05);
            overflow-y: auto;
        }

        #sidebar h3 {
            color: #689f38;
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
        }

        .sidebar-button {
            background-color: #c5e1a5;
            color: #333;
            border: none;
            border-radius: 8px;
            padding: 12px 10px;
            margin-bottom: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-align: left;
            display: flex;
            align-items: center;
        }

        .sidebar-button i {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .sidebar-button.active, .sidebar-button:hover {
            background-color: #8bc34a;
            color: white;
            transform: translateX(3px);
        }

        .chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #khung-tro-chuyen {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            border-bottom: 1px solid #b2ebf2;
            background-color: rgba(255, 255, 255, 0.8);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        .tin-nhan {
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 75%;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .tin-nhan-nguoi-dung {
            background-color: rgba(0, 123, 255, 0.9);
            color: white;
            margin-left: auto;
            text-align: right;
            border-bottom-right-radius: 5px;
        }

        .tin-nhan-bot {
            background-color: rgba(227, 242, 253, 0.9);
            color: #212121;
            margin-right: auto;
            text-align: left;
            border-bottom-left-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        #khu-vuc-nhap {
            display: flex;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
            align-items: center;
        }

        #o-nhap-tin-nhan-container {
            position: relative;
            flex-grow: 1;
            min-height: 48px;
            max-width: calc(100% - 70px);
        }

        #o-nhap-tin-nhan {
            width: 100%;
            background: transparent;
            position: relative;
            z-index: 1;
            color: transparent;
            caret-color: none;
            padding: 12px 18px;
            border: 1px solid #c5e1a5;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
            transition: border-color 0.3s ease;
            min-height: 48px;
            resize: none;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.8);
            box-sizing: border-box;
        }

        #o-nhap-tin-nhan:focus {
            border-color: #8bc34a;
            box-shadow: 0 0 0 3px rgba(139, 195, 74, 0.2);
        }

        #o-nhap-tin-nhan-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 48px;
            padding: 12px 18px;
            pointer-events: none;
            z-index: 2;
            white-space: pre-wrap;
            overflow: hidden;
            color: black;
            border: 1px solid transparent;
            border-radius: 25px;
            font-size: 16px;
            line-height: 1.4;
            box-sizing: border-box;
        }

        #nut-gui {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            margin-left: 15px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
            flex-shrink: 0;
        }

        #nut-gui:hover {
            background-color: #45a049;
        }

        #nut-gui:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            margin: 0 2px;
        }
        
        .fraction span {
            display: block;
        }
        
        .fraction .numerator {
            border-bottom: 1px solid #000;
            padding: 0 3px;
        }
        
        .fraction .denominator {
            padding: 0 3px;
        }

        .mixed-number {
            display: inline-flex;
            align-items: center;
            vertical-align: middle;
            margin: 0 2px;
        }
        
        .mixed-number .whole-part {
            padding-right: 2px;
        }
        
        .mixed-number .fraction {
            display: inline-block;
        }

        /* THAY ĐỔI: Di chuyển bộ đếm truy cập sang trái */
        #visit-counter {
            position: fixed;
            bottom: 80px;
            left: 10px; /* Đổi từ right sang left */
            background-color: rgba(38, 166, 154, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            display: block;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* THÊM MỚI: Bộ đếm câu hỏi */
        #question-counter {
            position: fixed;
            bottom: 125px; /* Đặt trên bộ đếm truy cập */
            left: 10px;
            background-color: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            display: block;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* THÊM MỚI: Nút thống kê */
        #stats-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(156, 39, 176, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        #stats-button:hover {
            background-color: rgba(123, 31, 162, 0.95);
            transform: scale(1.1);
        }

        /* THÊM MỚI: Modal thống kê */
        #stats-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        #stats-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        #stats-content h2 {
            color: #26a69a;
            margin-top: 0;
            text-align: center;
            margin-bottom: 20px;
        }

        #stats-content h3 {
            color: #4CAF50;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        .month-stats {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #4CAF50;
        }

        .month-stats h4 {
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .stats-label {
            font-weight: 600;
            color: #555;
        }

        .stats-value {
            color: #26a69a;
            font-weight: 700;
        }

        #close-stats {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            width: 100%;
            transition: background-color 0.3s ease;
        }

        #close-stats:hover {
            background-color: #d32f2f;
        }

        #home-button {
            position: absolute;
            top: 15px;
            left: 15px;
            background-color: #26a69a;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
            transition: background-color 0.3s ease;
        }

        #home-button:hover {
            background-color: #2c7873;
        }

        @media (max-width: 768px) {
            #home-menu h1 {
                font-size: 2em;
                margin-bottom: 30px;
                padding: 20px 30px;
            }

            .subject-buttons {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                gap: 20px;
                width: 95%;
            }

            .subject-button {
                padding: 20px 15px;
                font-size: 1.2em;
                background-color: rgba(76, 175, 80, 0.9);
                min-height: 120px;
            }

            .subject-button i {
                font-size: 2.5em;
                margin-bottom: 10px;
            }

            #contact-info {
                width: 95%;
                margin-top: 10px;
                padding: 12px;
                max-width: none;
            }
            
            #contact-info h3 {
                font-size: 1.1em;
            }
            
            .contact-item {
                font-size: 0.9em;
                flex-direction: column;
                text-align: center;
                margin-bottom: 10px;
            }
            
            .contact-item i {
                margin-right: 0;
                margin-bottom: 5px;
                font-size: 1em;
            }
            
            .contact-divider {
                display: none;
            }
            
            .contact-detail {
                display: block;
                margin: 3px 0;
            }

            footer {
                padding: 12px 0;
            }

            .footer-content p {
                font-size: 0.85em;
            }

            #chatbot-container {
                flex-direction: column;
                margin: 10px;
                border-radius: 8px;
            }

            #sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #dce775;
                padding: 10px;
                box-shadow: inset 0 -2px 5px rgba(0,0,0,0.05);
                flex-direction: row;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }

            #sidebar h3 {
                display: none;
            }

            .sidebar-button {
                flex-shrink: 0;
                width: auto;
                margin-bottom: 0;
                margin-right: 10px;
                padding: 8px 12px;
                font-size: 0.9em;
            }

            .sidebar-button i {
                font-size: 1em;
                margin-right: 5px;
            }

            .chat-area {
                min-height: 0;
            }

            #khung-tro-chuyen {
                padding: 10px;
            }

            .tin-nhan {
                max-width: 85%;
                padding: 8px 12px;
                font-size: 0.9em;
            }

            #khu-vuc-nhap {
                padding: 10px;
            }

            #o-nhap-tin-nhan-container {
                min-height: 40px;
                max-width: calc(100% - 60px);
            }

            #o-nhap-tin-nhan, #o-nhap-tin-nhan-preview {
                padding: 10px 15px;
                font-size: 14px;
                min-height: 40px;
            }

            #nut-gui {
                width: 40px;
                height: 40px;
                font-size: 20px;
                margin-left: 10px;
            }

            /* Điều chỉnh cho mobile */
            #visit-counter {
                bottom: 70px;
                left: 5px;
                padding: 6px 12px;
                font-size: 12px;
            }

            #question-counter {
                bottom: 110px;
                left: 5px;
                padding: 6px 12px;
                font-size: 12px;
            }

            #stats-button {
                bottom: 15px;
                right: 15px;
                width: 55px;
                height: 55px;
                font-size: 22px;
            }

            #stats-content {
                padding: 20px;
                width: 95%;
            }

            #home-button {
                width: 45px;
                height: 45px;
                font-size: 20px;
                top: 10px;
                left: 10px;
            }
        }
    </style>
</head>
<body>
    <button id="home-button" style="display: none;">
        <i class="fas fa-home"></i>
    </button>

    <!-- THAY ĐỔI: Thêm bộ đếm câu hỏi -->
    <div id="question-counter">
        <i class="fas fa-question-circle"></i> <span id="question-count">0</span> câu hỏi
    </div>

    <!-- THAY ĐỔI: Di chuyển bộ đếm truy cập sang trái -->
    <div id="visit-counter">
        <i class="fas fa-eye"></i> <span id="visit-count">0</span> lượt truy cập
    </div>

    <!-- THÊM MỚI: Nút thống kê -->
    <button id="stats-button">
        <i class="fas fa-chart-bar"></i>
    </button>

    <!-- THÊM MỚI: Modal thống kê -->
    <div id="stats-modal">
        <div id="stats-content">
            <h2><i class="fas fa-chart-pie"></i> Thống Kê Sử Dụng Chatbot</h2>
            
            <div id="monthly-stats-container">
                <!-- Nội dung thống kê sẽ được thêm vào đây -->
            </div>
            
            <button id="close-stats">Đóng</button>
        </div>
    </div>

    <div id="home-menu">
        <h1>Chatbot học tập nâng cao chất lượng tự học</h1>
        <div class="subject-buttons">
            <button class="subject-button" data-subject="toan">
                <i class="fas fa-calculator"></i>
                Toán
            </button>
            <button class="subject-button" data-subject="tieng-viet">
                <i class="fas fa-book-open"></i>
                Tiếng Việt
            </button>
            <button class="subject-button" data-subject="tieng-anh">
                <i class="fas fa-globe"></i>
                Tiếng Anh
            </button>
            <button class="subject-button" data-subject="tin-hoc">
                <i class="fas fa-laptop-code"></i>
                Tin Học
            </button>
            <button class="subject-button" data-subject="cong-nghe">
                <i class="fas fa-tools"></i>
                Công Nghệ
            </button>
            <button class="subject-button" data-subject="lich-su-dia-ly">
                <i class="fas fa-map-marked-alt"></i>
                Lịch Sử & Địa Lý
            </button>
            <button class="subject-button" data-subject="khoa-hoc">
                <i class="fas fa-flask"></i>
                Khoa Học
            </button>
        </div>
        
        <div id="contact-info">
            <h3><i class="fas fa-address-card"></i> Thông tin liên hệ</h3>
            <div class="contact-item">
                <i class="fas fa-user-graduate"></i> <span class="contact-name">Nguyễn Đình Duy</span>
                <span class="contact-detail">
                    <i class="fas fa-phone-alt"></i> SĐT: 0865328988
                </span>
                <span class="contact-divider">|</span>
                <span class="contact-detail">
                    <i class="fas fa-envelope"></i> Email: ndduy100592@tuyenquang.edu.vn
                </span>
            </div>
        </div>
    </div>

    <div id="chatbot-container">
        <div id="sidebar">
            <h3>Môn học</h3>
            <button class="sidebar-button" data-subject="toan">
                <i class="fas fa-calculator"></i>
                Toán
            </button>
            <button class="sidebar-button" data-subject="tieng-viet">
                <i class="fas fa-book-open"></i>
                Tiếng Việt
            </button>
            <button class="sidebar-button" data-subject="tieng-anh">
                <i class="fas fa-globe"></i>
                Tiếng Anh
            </button>
            <button class="sidebar-button" data-subject="tin-hoc">
                <i class="fas fa-laptop-code"></i>
                Tin Học
            </button>
            <button class="sidebar-button" data-subject="cong-nghe">
                <i class="fas fa-tools"></i>
                Công Nghệ
            </button>
            <button class="sidebar-button" data-subject="lich-su-dia-ly">
                <i class="fas fa-map-marked-alt"></i>
                Lịch Sử & Địa Lý
            </button>
            <button class="sidebar-button" data-subject="khoa-hoc">
                <i class="fas fa-flask"></i>
                Khoa Học
            </button>
        </div>
        <div class="chat-area">
            <div id="khung-tro-chuyen">
            </div>
            <div id="khu-vuc-nhap">
                <div id="o-nhap-tin-nhan-container">
                    <textarea id="o-nhap-tin-nhan" placeholder="Nhập câu hỏi của em ..." rows="1"></textarea>
                    <div id="o-nhap-tin-nhan-preview"></div>
                </div>
                <button id="nut-gui">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <footer id="main-footer">
        <div class="footer-line"></div>
        <div class="footer-content">
            <p><i class="fas fa-tree"></i> Ảnh cây đa Tân Trào (nguồn: sưu tầm Internet)</p>
        </div>
    </footer>

    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const firebaseConfig = {
            apiKey: "AIzaSyCyhGASygL5BVBB-0pJJNwoyTZ61pAzP7c",
            authDomain: "tieuhoc-a7f57.firebaseapp.com",
            projectId: "tieuhoc-a7f57",
            storageBucket: "tieuhoc-a7f57.appspot.com",
            messagingSenderId: "736631398515",
            appId: "1:736631398515:web:a41bbabeeb98c3df42ca06"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const KHOA_API_REVERSED = "AIzaSyDhG97pVTKbdQx4kERvfpH7C1euPJYfP2Y"; 
        
        function reverseApiKey(reversedKey) {
            return reversedKey.split('').reverse().join('');
        }
        
        const KHOA_API = reverseApiKey(KHOA_API_REVERSED);
        const moHinhAI = new GoogleGenerativeAI(KHOA_API);
        const moHinh = moHinhAI.getGenerativeModel({ model: "gemini-2.5-flash" });

        const homeMenu = document.getElementById('home-menu');
        const chatbotContainer = document.getElementById('chatbot-container');
        const khungTroChuyen = document.getElementById('khung-tro-chuyen');
        const oNhapTinNhan = document.getElementById('o-nhap-tin-nhan');
        const oNhapTinNhanPreview = document.getElementById('o-nhap-tin-nhan-preview');
        const nutGui = document.getElementById('nut-gui');
        const subjectButtons = document.querySelectorAll('.subject-button');
        const sidebarButtons = document.querySelectorAll('.sidebar-button');
        const visitCounter = document.getElementById('visit-counter');
        const visitCountSpan = document.getElementById('visit-count');
        const homeButton = document.getElementById('home-button');
        const mainFooter = document.getElementById('main-footer');
        
        // THÊM MỚI: Biến cho bộ đếm câu hỏi
        const questionCounter = document.getElementById('question-counter');
        const questionCountSpan = document.getElementById('question-count');
        
        // THÊM MỚI: Biến cho nút thống kê
        const statsButton = document.getElementById('stats-button');
        const statsModal = document.getElementById('stats-modal');
        const statsContent = document.getElementById('stats-content');
        const monthlyStatsContainer = document.getElementById('monthly-stats-container');
        const closeStats = document.getElementById('close-stats');

        let currentSubject = '';
        let homeworkData = {};
        let totalVisits = 0;
        let totalQuestions = 0;

        // SỬA LỖI: Thêm đối tượng để chuyển đổi mã môn học thành tên hiển thị
        const subjectDisplayNames = {
            "toan": "Toán",
            "tieng-viet": "Tiếng Việt",
            "tieng-anh": "Tiếng Anh",
            "tin-hoc": "Tin Học",
            "cong-nghe": "Công Nghệ",
            "lich-su-dia-ly": "Lịch Sử & Địa Lý",
            "khoa-hoc": "Khoa Học"
        };

        const subjectFilters = {
            "toan": {
                name: "Toán",
                excludeKeywords: ["đại số tuyến tính", "giải tích", "lượng tử", "phân tích chuyên sâu"],
                homeworkExamples: []
            },
            "tieng-viet": {
                name: "Tiếng Việt",
                excludeKeywords: ["nghiên cứu văn học", "phân tích chuyên sâu", "triết học", "ngữ pháp nâng cao", "phản biện văn học"],
                homeworkExamples: []
            },
            "tieng-anh": {
                name: "Tiếng Anh",
                excludeKeywords: ["advanced grammar", "literary analysis", "linguistics", "academic writing", "syntax"],
                homeworkExamples: []
            },
            "tin-hoc": {
                name: "Tin Học",
                excludeKeywords: ["lập trình", "trí tuệ nhân tạo", "máy học", "công nghệ thông tin chuyên sâu", "thuật toán phức tạp", "mạng máy tính"],
                homeworkExamples: []
            },
            "cong-nghe": {
                name: "Công Nghệ",
                excludeKeywords: ["kỹ thuật", "công nghệ cao", "tự động hóa", "robotics", "thiết kế mạch", "vật liệu mới"],
                homeworkExamples: []
            },
            "lich-su-dia-ly": {
                name: "Lịch Sử & Địa Lý",
                excludeKeywords: ["nghiên cứu sử học", "phân tích địa chính trị", "kinh tế học", "xã hội học", "diễn biến phức tạp", "lý thuyết địa lý"],
                homeworkExamples: []
            },
            "khoa-hoc": {
                name: "Khoa Học",
                excludeKeywords: ["vật lý lượng tử", "hóa học hữu cơ", "sinh học phân tử", "thiên văn học", "di truyền học", "nghiên cứu khoa học chuyên sâu"],
                homeworkExamples: []
            }
        };

        const generalExcludeKeywords = [
            "đại học", "cao học", "nghiên cứu", "phân tích chuyên sâu", "vật lý hạt nhân", "triết học",
            "kinh tế vĩ mô", "chính trị quốc tế", "chứng minh", "phản biện", "tôn giáo", "đức tin"
        ];
        
        const homeworkRequestPhrases = /(cho (tôi|em) bài tập|xin bài tập|gợi ý bài tập|bài tập về)/;

        // THÊM MỚI: Hàm lưu câu hỏi vào Firebase
        async function saveQuestion(questionText, subject) {
            try {
                const questionData = {
                    question: questionText,
                    subject: subject,
                    subjectName: subjectDisplayNames[subject] || subject, // Lưu cả tên hiển thị
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    monthYear: getCurrentMonthYear()
                };
                
                await db.collection('questions').add(questionData);
                
            } catch (error) {
                console.error("Lỗi khi lưu câu hỏi:", error);
            }
        }

        // THÊM MỚI: Hàm lấy tổng số câu hỏi
        async function getTotalQuestions() {
            try {
                const questionsSnapshot = await db.collection('questions').get();
                totalQuestions = questionsSnapshot.size;
                questionCountSpan.textContent = totalQuestions.toLocaleString();
                // CHỈ HIỂN THỊ Ở TRANG CHỦ, KHÔNG HIỂN THỊ KHI CHAT
                if (homeMenu.style.display !== 'none') {
                    questionCounter.style.display = 'block';
                }
            } catch (error) {
                console.error("Lỗi khi lấy số câu hỏi:", error);
            }
        }

        // THÊM MỚI: Hàm lấy thống kê theo tháng
        async function getMonthlyStats() {
            try {
                const questionsSnapshot = await db.collection('questions').get();
                const monthlyStats = {};
                
                questionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const timestamp = data.timestamp;
                    
                    if (timestamp) {
                        const date = timestamp.toDate();
                        const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
                        
                        if (!monthlyStats[monthYear]) {
                            monthlyStats[monthYear] = {
                                totalQuestions: 0,
                                subjects: {}
                            };
                        }
                        
                        monthlyStats[monthYear].totalQuestions++;
                        
                        // SỬA LỖI: Sử dụng tên hiển thị thay vì mã môn học
                        const subjectKey = data.subject || 'Không xác định';
                        const subjectName = data.subjectName || subjectDisplayNames[subjectKey] || subjectKey;
                        
                        if (!monthlyStats[monthYear].subjects[subjectName]) {
                            monthlyStats[monthYear].subjects[subjectName] = 0;
                        }
                        monthlyStats[monthYear].subjects[subjectName]++;
                    } else if (data.monthYear) {
                        const monthYear = data.monthYear;
                        
                        if (!monthlyStats[monthYear]) {
                            monthlyStats[monthYear] = {
                                totalQuestions: 0,
                                subjects: {}
                            };
                        }
                        
                        monthlyStats[monthYear].totalQuestions++;
                        
                        // SỬA LỖI: Sử dụng tên hiển thị thay vì mã môn học
                        const subjectKey = data.subject || 'Không xác định';
                        const subjectName = data.subjectName || subjectDisplayNames[subjectKey] || subjectKey;
                        
                        if (!monthlyStats[monthYear].subjects[subjectName]) {
                            monthlyStats[monthYear].subjects[subjectName] = 0;
                        }
                        monthlyStats[monthYear].subjects[subjectName]++;
                    }
                });
                
                return monthlyStats;
                
            } catch (error) {
                console.error("Lỗi khi lấy thống kê theo tháng:", error);
                return {};
            }
        }

        // THÊM MỚI: Hàm hiển thị thống kê
        async function displayMonthlyStats() {
            const monthlyStats = await getMonthlyStats();
            monthlyStatsContainer.innerHTML = '';
            
            if (Object.keys(monthlyStats).length === 0) {
                monthlyStatsContainer.innerHTML = '<p>Chưa có dữ liệu thống kê.</p>';
                return;
            }
            
            // Sắp xếp các tháng theo thứ tự mới nhất trước
            const sortedMonths = Object.keys(monthlyStats).sort((a, b) => {
                const [monthA, yearA] = a.split('/').map(Number);
                const [monthB, yearB] = b.split('/').map(Number);
                
                if (yearB !== yearA) return yearB - yearA;
                return monthB - monthA;
            });
            
            // Hiển thị tổng quát
            const totalStats = document.createElement('div');
            totalStats.className = 'month-stats';
            totalStats.innerHTML = `
                <h4><i class="fas fa-chart-line"></i> Tổng Quan</h4>
                <div class="stats-item">
                    <span class="stats-label">Tổng số câu hỏi:</span>
                    <span class="stats-value">${totalQuestions.toLocaleString()}</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">Tổng lượt truy cập:</span>
                    <span class="stats-value">${totalVisits.toLocaleString()}</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">Số tháng có dữ liệu:</span>
                    <span class="stats-value">${sortedMonths.length}</span>
                </div>
            `;
            monthlyStatsContainer.appendChild(totalStats);
            
            // Hiển thị thống kê từng tháng
            sortedMonths.forEach(monthYear => {
                const stats = monthlyStats[monthYear];
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month-stats';
                
                let subjectDetails = '';
                // SỬA LỖI: Sắp xếp môn học theo số lượng giảm dần
                const sortedSubjects = Object.entries(stats.subjects).sort((a, b) => b[1] - a[1]);
                
                sortedSubjects.forEach(([subjectName, count]) => {
                    subjectDetails += `
                        <div class="stats-item">
                            <span class="stats-label">${subjectName}:</span>
                            <span class="stats-value">${count}</span>
                        </div>
                    `;
                });
                
                monthDiv.innerHTML = `
                    <h4><i class="fas fa-calendar-alt"></i> Tháng ${monthYear}</h4>
                    <div class="stats-item">
                        <span class="stats-label">Tổng câu hỏi:</span>
                        <span class="stats-value">${stats.totalQuestions}</span>
                    </div>
                    ${sortedSubjects.length > 0 ? `
                    <h5 style="margin-top: 15px; margin-bottom: 10px; color: #666;">Phân bổ theo môn học:</h5>
                    ${subjectDetails}
                    ` : '<p style="color: #666; margin-top: 10px;">Không có dữ liệu phân bổ môn học</p>'}
                `;
                
                monthlyStatsContainer.appendChild(monthDiv);
            });
        }

        // THÊM MỚI: Hàm lấy tháng/năm hiện tại
        function getCurrentMonthYear() {
            const now = new Date();
            return `${now.getMonth() + 1}/${now.getFullYear()}`;
        }

        async function trackVisit() {
            try {
                const visitData = {
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userAgent: navigator.userAgent,
                    screenResolution: `${window.screen.width}x${window.screen.height}`,
                    language: navigator.language,
                    platform: navigator.platform
                };
                
                await db.collection('visits').add(visitData);
                
            } catch (error) {
                console.error("Lỗi khi lưu lượt truy cập:", error);
            }
        }

        async function getTotalVisits() {
            try {
                const visitsSnapshot = await db.collection('visits').get();
                totalVisits = visitsSnapshot.size;
                visitCountSpan.textContent = totalVisits.toLocaleString();
                // CHỈ HIỂN THỊ Ở TRANG CHỦ, KHÔNG HIỂN THỊ KHI CHAT
                if (homeMenu.style.display !== 'none') {
                    visitCounter.style.display = 'block';
                }
            } catch (error) {
                console.error("Lỗi khi lấy số lượt truy cập:", error);
            }
        }

        async function loadHomeworkData() {
            try {
                const response = await fetch('baitap.txt');
                if (!response.ok) {
                    throw new Error(`Lỗi HTTP! status: ${response.status}`);
                }
                const text = await response.text();
                const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);

                let currentSection = '';
                for (const line of lines) {
                    if (line.startsWith('#')) {
                        currentSection = line.substring(1);
                        homeworkData[currentSection] = [];
                    } else if (currentSection && homeworkData[currentSection]) {
                        homeworkData[currentSection].push(line);
                    }
                }
                
                for (const subjectKey in homeworkData) {
                    if (subjectFilters[subjectKey]) {
                        subjectFilters[subjectKey].homeworkExamples = homeworkData[subjectKey];
                    }
                }
            } catch (error) {
                for (const key in subjectFilters) {
                    subjectFilters[key].homeworkExamples = [];
                }
            }
        }

        function initApp() {
            subjectButtons.forEach(button => {
                button.addEventListener('click', () => selectSubject(button.dataset.subject));
            });

            sidebarButtons.forEach(button => {
                button.addEventListener('click', () => selectSubject(button.dataset.subject));
            });

            homeButton.addEventListener('click', backToHome);

            nutGui.addEventListener('click', guiTinNhan);
            
            oNhapTinNhan.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    guiTinNhan();
                }
            });

            oNhapTinNhan.addEventListener('input', function() {
                updateInputPreview();
                adjustTextareaHeight();
            });

            // THÊM MỚI: Xử lý nút thống kê
            statsButton.addEventListener('click', () => {
                statsModal.style.display = 'flex';
                displayMonthlyStats();
            });

            closeStats.addEventListener('click', () => {
                statsModal.style.display = 'none';
            });

            // Đóng modal khi click ra ngoài
            statsModal.addEventListener('click', (e) => {
                if (e.target === statsModal) {
                    statsModal.style.display = 'none';
                }
            });

            // Theo dõi lượt truy cập khi trang được tải
            trackVisit();
            getTotalVisits();
            getTotalQuestions();
            
            // Cập nhật số lượt truy cập và câu hỏi mỗi 30 giây
            setInterval(() => {
                getTotalVisits();
                getTotalQuestions();
            }, 30000);
        }

        function backToHome() {
            homeMenu.style.display = 'flex';
            chatbotContainer.style.display = 'none';
            homeButton.style.display = 'none';
            statsButton.style.display = 'flex'; // HIỂN THỊ NÚT THỐNG KÊ Ở TRANG CHỦ
            visitCounter.style.display = 'block';
            questionCounter.style.display = 'block'; // HIỂN THỊ BỘ ĐẾM CÂU HỎI Ở TRANG CHỦ
            mainFooter.style.display = 'block';
        }

        function adjustTextareaHeight() {
            oNhapTinNhan.style.height = 'auto';
            oNhapTinNhan.style.height = (oNhapTinNhan.scrollHeight) + 'px';
            oNhapTinNhanPreview.style.height = oNhapTinNhan.style.height;
        }

        function updateInputPreview() {
            const text = oNhapTinNhan.value;
            oNhapTinNhanPreview.innerHTML = formatFractionsAndMixedNumbers(escapeHtml(text));
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function formatFractionsAndMixedNumbers(text) {
            const mixedNumberRegex = /(\d+)(?:\s|)(\()(\d+)\/(\d+)(\))/g;
            let processedText = text.replace(mixedNumberRegex, (match, whole, p1, numerator, denominator, p2) => {
                return `<span class="mixed-number"><span class="whole-part">${whole}</span><span class="fraction"><span class="numerator">${numerator}</span><span class="denominator">${denominator}</span></span></span>`;
            });
            
            const fractionRegex = /([^\/\s]+)\/([^\/\s]+)/g;
            processedText = processedText.replace(fractionRegex, (match, numerator, denominator) => {
                if (processedText.includes(`<span class="mixed-number"><span class="whole-part">`)) {
                    return match;
                }
                return `<span class="fraction"><span class="numerator">${numerator}</span><span class="denominator">${denominator}</span></span>`;
            });
            
            return processedText;
        }

        function selectSubject(subject) {
            currentSubject = subject;
            homeMenu.style.display = 'none';
            chatbotContainer.style.display = 'flex';
            khungTroChuyen.innerHTML = '';
            themTinNhanVaoGiaoDien("bot", `Chào mừng em đến với môn ${subjectFilters[subject].name}! Thầy có thể giúp gì cho em?`);
            homeButton.style.display = 'flex';
            statsButton.style.display = 'none'; // ẨN NÚT THỐNG KÊ KHI CHAT
            visitCounter.style.display = 'none';
            questionCounter.style.display = 'none'; // ẨN BỘ ĐẾM CÂU HỎI KHI CHAT
            mainFooter.style.display = 'none';

            sidebarButtons.forEach(button => {
                if (button.dataset.subject === subject) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        function themTinNhanVaoGiaoDien(nguoiGui, vanBan) {
            const divTinNhan = document.createElement('div');
            divTinNhan.classList.add('tin-nhan', `tin-nhan-${nguoiGui}`);

            let processedText = formatFractionsAndMixedNumbers(vanBan);
            processedText = processedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            processedText = processedText.replace(/\n/g, '<br>');

            divTinNhan.innerHTML = processedText;
            khungTroChuyen.appendChild(divTinNhan);
            khungTroChuyen.scrollTop = khungTroChuyen.scrollHeight;
        }

        async function guiTinNhan() {
            const tinNhanNguoiDung = oNhapTinNhan.value.trim();
            if (!tinNhanNguoiDung) return;

            themTinNhanVaoGiaoDien("nguoi-dung", tinNhanNguoiDung);
            
            // THÊM MỚI: Lưu câu hỏi vào Firebase và cập nhật bộ đếm
            if (currentSubject) {
                await saveQuestion(tinNhanNguoiDung, currentSubject);
                await getTotalQuestions(); // Cập nhật số câu hỏi ngay lập tức
            }
            
            oNhapTinNhan.value = '';
            oNhapTinNhanPreview.innerHTML = '';
            adjustTextareaHeight();

            const loiChao = ["chào"];
            if (loiChao.some(chao => tinNhanNguoiDung.toLowerCase().includes(chao))) {
                themTinNhanVaoGiaoDien("bot", `Chào em! Thầy là một chatbot AI được thiết kế để trả lời các câu hỏi cấp tiểu học cho môn ${subjectFilters[currentSubject].name}. Bạn có câu hỏi gì không?`);
                return;
            }

            const isAskingForHomework = homeworkRequestPhrases.test(tinNhanNguoiDung.toLowerCase());

            if (isAskingForHomework) {
                if (currentSubject && subjectFilters[currentSubject] && subjectFilters[currentSubject].homeworkExamples.length > 0) {
                    let examples = subjectFilters[currentSubject].homeworkExamples.map((e, i) => `${i + 1}. ${e}`).join('\n');
                    themTinNhanVaoGiaoDien("bot", `Chào em! Thầy có một vài dạng bài tập cơ bản mà em có thể tham khảo trong môn **${subjectFilters[currentSubject].name}** đây:\n${examples}\n\nEm hãy thử giải các bài tập này và hỏi thầy nếu có bất kỳ câu hỏi nào về cách làm nhé!`);
                } else {
                    themTinNhanVaoGiaoDien("bot", "Chào em! Hiện tại thầy chưa có sẵn bài tập cho môn này. Thay vào đó, em có thể hỏi thầy về cách làm một dạng bài tập nào đó, thầy sẽ hướng dẫn em nhé!");
                }
                return;
            }

            if (!laCauHoiTieuHoc(tinNhanNguoiDung)) {
                themTinNhanVaoGiaoDien("bot", "Xin lỗi, tôi chỉ có thể giúp bạn với các câu hỏi và bài tập ở cấp độ tiểu học. Vui lòng hỏi những câu hỏi phù hợp hơn nhé.");
                return;
            }

            try {
                const loiNhac = `Bạn là một giáo viên AI thân thiện và hữu ích (lưu ý bạn luôn là thầy giáo và xưng hô với người dùng là thầy - em), chuyên giải đáp các câu hỏi và gợi ý cách làm bài tập cho học sinh tiểu học trong môn ${subjectFilters[currentSubject].name}. Hãy trả lời một cách đơn giản, dễ hiểu, và chỉ tập trung vào kiến thức cấp tiểu học. Tuyệt đối không giải bài tập cụ thể, chỉ gợi ý phương pháp hoặc hướng dẫn. Nếu câu hỏi không phù hợp cấp tiểu học hoặc yêu cầu giải bài tập chi tiết, hãy từ chối một cách nhẹ nhàng và lịch sự. Nếu người dùng xin bài tập để làm thì cũng có thể được.
                \n\nCâu hỏi: ${tinNhanNguoiDung}`;

                const ketQua = await moHinh.generateContent(loiNhac);
                const phanHoi = await ketQua.response;
                const traLoiBot = phanHoi.text();
                themTinNhanVaoGiaoDien("bot", traLoiBot);

            } catch (loi) {
                console.error("Lỗi khi gọi API Gemini: ", loi);
                themTinNhanVaoGiaoDien("bot", "Rất tiếc, có lỗi xảy ra. Vui lòng thử lại sau nhé!");
            }
        }

        function laCauHoiTieuHoc(cauHoi) {
            const cauHoiThuong = cauHoi.toLowerCase();

            const laKhongTieuHocChung = generalExcludeKeywords.some(tuKhoa => cauHoiThuong.includes(tuKhoa));
            if (laKhongTieuHocChung) return false;
            if (currentSubject && subjectFilters[currentSubject]) {
                const subjectSpecificKeywords = subjectFilters[currentSubject].excludeKeywords;
                const laKhongTieuHocMonHoc = subjectSpecificKeywords.some(tuKhoa => cauHoiThuong.includes(tuKhoa));
                if (laKhongTieuHocMonHoc) return false;
            }
            return true;
        }

        function laYeuCauGiaiBaiTap(cauHoi) {
            const cauHoiThuong = cauHoi.toLowerCase();
            return homeworkRequestPhrases.test(cauHoiThuong);
        }

        loadHomeworkData();
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
